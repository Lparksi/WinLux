name: WinLux Build

on:
  push:
    branches:
      - '**'
    tags:
      - 'v*'
  pull_request:
    branches:
      - '**'
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: winlux-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-windows:
    name: Verify & Build (Windows)
    runs-on: windows-latest
    timeout-minutes: 60
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            . -> target
            src-tauri -> src-tauri/target

      - name: Install Dependencies
        run: bun install --frozen-lockfile

      - name: Type Check
        run: bun run typecheck

      - name: Ensure Frontend Dist Path
        shell: pwsh
        run: |
          if (-not (Test-Path 'dist')) {
            New-Item -ItemType Directory -Path 'dist' | Out-Null
          }

      - name: Rust Tests
        run: cargo test -p winlux

      - name: Resolve Build Version
        id: version
        if: github.event_name != 'pull_request'
        shell: pwsh
        run: |
          $semverPattern = '^\d+\.\d+\.\d+(?:-[0-9A-Za-z.-]+)?(?:\+[0-9A-Za-z.-]+)?$'
          $msiCompatiblePattern = '^\d+\.\d+\.\d+(?:-(\d+))?(?:\+[0-9A-Za-z.-]+)?$'
          $isTag = '${{ github.ref_type }}' -eq 'tag'

          if ($isTag) {
            $rawTag = '${{ github.ref_name }}'
            $normalized = $rawTag -replace '^[vV]', ''
            if (-not $normalized -or -not ($normalized -match $semverPattern)) {
              throw "tag 必须是 semver（例如 v1.2.3）"
            }

            if (-not ($normalized -match $msiCompatiblePattern)) {
              throw "MSI 目标要求预发布标识必须是纯数字（例如 v1.2.3-123）"
            }

            if ($Matches[1]) {
              $preNumber = [int]$Matches[1]
              if ($preNumber -gt 65535) {
                throw "MSI 目标要求预发布标识不能大于 65535"
              }
            }

            $version = $normalized
            $source = "tag:$rawTag"
          } else {
            $rawTag = ''
            $rawTagOutput = git describe --tags --abbrev=0 --exclude "${{ github.ref_name }}" 2>$null
            if ($LASTEXITCODE -eq 0 -and $rawTagOutput) {
              $rawTag = $rawTagOutput.Trim()
            } else {
              $global:LASTEXITCODE = 0
            }

            if (-not $rawTag) {
              $rawTag = 'v0.0.1'
            }

            $baseVersion = $rawTag -replace '^[vV]', ''
            if (-not ($baseVersion -match $semverPattern)) {
              $baseVersion = '0.0.1'
            }

            if ($baseVersion -match '^(\d+\.\d+\.\d+)') {
              $baseVersion = $Matches[1]
            } else {
              $baseVersion = '0.0.1'
            }

            $runNumber = [int]'${{ github.run_number }}'
            $preNumber = [Math]::Min($runNumber, 65535)
            $version = "$baseVersion-$preNumber"
            $source = "prev-tag:$rawTag + run:$runNumber"
          }

          "version=$version" >> $env:GITHUB_OUTPUT
          "is_tag=$($isTag.ToString().ToLower())" >> $env:GITHUB_OUTPUT

          Write-Host "Resolved version: $version"
          Write-Host "Version source: $source"

      - name: Build Tauri Bundle
        if: github.event_name != 'pull_request'
        env:
          WINLUX_VERSION: ${{ steps.version.outputs.version }}
        run: bun run tauri:build

      - name: Upload Artifacts
        if: github.event_name != 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: winlux-${{ steps.version.outputs.version }}-windows
          path: |
            target/release/bundle/**/*.exe
            target/release/bundle/**/*.msi
            src-tauri/target/release/bundle/**/*.exe
            src-tauri/target/release/bundle/**/*.msi
          if-no-files-found: error

  publish-release:
    name: Publish GitHub Release (Tag)
    needs: build-windows
    if: github.ref_type == 'tag'
    runs-on: windows-latest
    timeout-minutes: 15
    permissions:
      contents: write

    steps:
      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: winlux-${{ needs.build-windows.outputs.version }}-windows
          path: release-assets

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: WinLux ${{ needs.build-windows.outputs.version }}
          generate_release_notes: true
          files: |
            release-assets/**/*.exe
            release-assets/**/*.msi
